{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlowFin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/creditor/konveyer.css' %}">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="icon" href="{% static 'img/icon.ico' %}" type="image/x-icon">
</head>
<body>

<!-- ================= TOP BAR ================= -->
<header class="topbar">
    <div>
        <h1><a href="{% url 'home' %}" style="color: white;text-decoration: none;">FlexFlow | â„–{{loan.contract_id}}</a></h1>
        <span class="subtitle">FlowFin BY DIZENSTUDIOS</span>
    </div>
    <div class="user-box"><a href="{% url 'auth:logout' %}" style="text-decoration: none;color: white;">{{ user.full_name }}</a></div>
</header>

<!-- ================= STEPS ================= -->
<nav class="steps">
    <button class="step">1. Mahsulot</button>
    <button class="step">2. Mijoz</button>
    <button class="step">3. Raqamlar</button>
    <button class="step">4. Tasdiqlash</button>
    <button class="step">5. Hujjatlar</button>
    <button class="step">6. Yakunlash</button>
</nav>

<!-- ================= ALERTS ================= -->
<div id="alerts"></div>

<!-- ================= CONTENT ================= -->
<main class="container">

<!-- ===== TAB 1 ===== -->
<section class="tab">
<h2>Mahsulot maâ€™lumotlari</h2>
<div class="card grid-2">
    <div class="field">
        <label>Mahsulot</label>
        <select id="product">
            {% for i in products%}
            <option value="{{i.id}}" {% if i.id == loan.product.id %} selected {% endif %}>{{ i.name }}</option>
            {% endfor %}
        </select>
        <button class="primary" onclick="save_product()">Saqlash</button>
    </div>
    <div class="field">
        <label>Asl narxi</label>
        <input id="price" readonly value="{{ loan.product.price }}">
    </div>
    <div class="field">
        <label>Yillik foiz (%)</label>
        <input id="loan_rate" value="{{ loan.rate }}">
    </div>
    <div class="field">
        <label>Kunlik jarima foizi</label>
        <input id="loan_fine" value="{{ loan.fine }}">
    </div>
    <div class="field">
        <label>Boshlanish sanasi</label>
        <input id="loan_start_date" type="date" readonly value="{{ loan.start_date|date:'Y-m-d' }}">
    </div>
    <div class="field">
        <label>Tugash sanasi</label>
        <input id="loan_end_date" type="date" value="{{ loan.end_date|date:'Y-m-d' }}">
    </div>
    <div class="field">
        <label>To'lov sanasi</label>
        <input id="payday" type="number" value="{{ loan.payday }}">
    </div>
    <div class="field">
        <label>Foiz bilan jami summa</label>
        <input id="total_amount" readonly value="{{ loan.amount }}">
    </div>
    <div class="field">
        <label>Oylik toâ€˜lov</label>
        <input id="monthly_payment" value="{{loan.payment}}" readonly>
    </div>
    <div class="field">
        <button class="primary" id="make_graphic" onclick="calculateMonthlyPayment()">Grafikni tuzish</button>
    </div>
</div>
</section>

<!-- ===== TAB 2 ===== -->
<section class="tab">
<h2>Mijoz maâ€™lumotlari</h2>
<div class="card grid-3">

    <!-- PINFL first -->
    <div class="field">
        <label>PINFL</label>
        <input id="client_pinfl" value="{{loan.client.passport_pinfl}}" placeholder="PINFL">
    </div>
    <div class="field" style="align-self:end;">
        <button class="primary" onclick="add_client()">Izlash</button>
    </div>

    <!-- Other fields -->
    <div class="field"><label>Familiya</label><input id="last_name" value="{{loan.client.last_name}}"></div>
    <div class="field"><label>Ism</label><input id="first_name" value="{{loan.client.first_name}}"></div>
    <div class="field"><label>Otasining ismi</label><input id="middle_name" value="{{loan.client.middle_name}}"></div>
    <div class="field"><label>Tugâ€˜ilgan sana</label><input id="birth_date" type="date" value="{{loan.client.birth_date|date:'Y-m-d'}}"></div>
    <div class="field">
        <label>Jinsi</label>
        <select id="gender">
            <option value="male" {% if loan.client.gender == "male" %} selected {% endif %}>Erkak</option>
            <option value="female" {% if loan.client.gender == "female" %} selected {% endif %}>Ayol</option>
        </select>
    </div>

</div>

<h2>Passport maâ€˜lumotlari</h2>
<div class="card grid-3">
    <div class="field"><label>Passport seriyasi</label><input id="passport_serial" value="{{loan.client.passport_serial}}"></div>
    <div class="field"><label>Olingan sanasi</label><input id="passport_got_date" type="date" value="{{loan.client.passport_got_date|date:'Y-m-d'}}"></div>
    <div class="field"><label>Tugash sanasi</label><input id="passport_expiry_date" type="date" value="{{loan.client.passport_expiry_date|date:'Y-m-d'}}"></div>
    <div class="field"><label>Olingan region</label><input id="passport_got_region" value="{{loan.client.passport_got_region}}"></div>
</div>

<h2>Manzil</h2>
<div class="card grid-3">
    <div class="field"><label>Davlat bazasidan yashash joyi</label><input id="gov_address" value="{{loan.client.gov_address}}"></div>
    <div class="field"><label>Joriy yashash joyi</label><input id="current_address" value="{{loan.client.current_address}}"></div>
</div>
<div class="card grid-3">
    <div class="field"><label>Moâ€˜ljal</label><input id="location" value="{{loan.client.location}}"></div>
</div>

<h2>Mijoz kredit holati</h2>
<div class="card grid-3">
    <div class="field"><label>Kreditlar soni</label><input id="loans" value="{{loan.loans}}" type="number"></div>
    <div class="field"><label>Jami oylik toâ€˜lovi</label><input id="monthly_loan_payment" value="{{loan.monthly_loan_payment}}" type="number"></div>
    <div class="field"><label>KATM scoring bali</label><input type="number" id="scoring" value="{{loan.scoring}}"></div>
</div>

<h2>Daromadlari</h2>
<div class="card grid-3">
    <div class="field"><label>Daromad tavsifi</label><input id="work_type" value="{{loan.work_type}}"></div>
    <div class="field"><label>Oylik daromadi</label><input type="number" id="monthly_income" value="{{loan.monthly_income}}"></div>
    <div class="field"><label>Oylik chiqimi</label><input type="number" id="monthly_spending" value="{{loan.monthly_spending}}"></div>
</div>

<h2>Izoh</h2>
<div class="card grid-3">
    <div class="field"><label>Mijoz haqida izoh</label><input id="description" value="{{loan.client.description}}"></div>
</div>
</section>


<!-- ===== TAB 3 ===== -->
<section class="tab">
<h2>Telefon</h2>
<div class="card">

    <!-- ===== ADD CARD ===== -->
    <!-- <h3>Karta qoâ€˜shish (Tayyor emas)</h3>
    <div class="add-form grid-3">
        <div class="field">
            <label>Karta raqami</label>
            <input id="new_card" placeholder="8600 **** **** ****">
        </div>
        <div class="field">
            <label>Izoh</label>
            <input id="new_card_comment" placeholder="Asosiy karta, Ijara...">
        </div>
        <div class="field" style="align-self:end;">
            <button class="primary" onclick="addCard()">Qoâ€˜shish</button>
        </div>
    </div> -->

    <!-- LIST OF CARDS -->
    <!-- <div id="card_list" style="margin-top:10px; display:flex;flex-direction:column; gap:10px;">
        <div class="doc">
            <span>ðŸ’³ Uzcard **** 8844</span>
            <span>Asosiy karta</span>
            <button class="danger">Oâ€˜chirish</button>
        </div>
    </div>

    <hr style="margin:20px 0; border:1px dashed #ccc;"> -->

    <!-- ===== ADD PHONE ===== -->
    <h3>Telefon qoâ€˜shish</h3>
    <div class="add-form grid-3">
        <div class="field">
            <label>Tel. raqam</label>
            <input id="new_number" placeholder="+998 90 123 45 67">
        </div>
        <div class="field">
            <label>Izoh</label>
            <input id="new_number_comment" placeholder="Oâ€˜zi, Oila...">
        </div>
        <div class="field" style="align-self:end;">
            <button class="primary" onclick="save_number()">Qoâ€˜shish</button>
        </div>
    </div>

    <!-- LIST OF PHONE NUMBERS -->
    <div id="number_list" class="number_list" style="margin-top:10px; display:flex;flex-direction:column; gap:10px;padding-top: 10px;">
        {% for i in loan.client.numbers.all %}
        <div class="doc number_{{i.id}}">
            <span>{{i.number}}</span>
            <span>{{i.name}}</span>
            <button class="danger" id="{{i.id}}" onclick="delete_number(this)">Oâ€˜chirish</button>
        </div>
        {% endfor %}
    </div>

</div>
</section>

<!-- ===== TAB 4 ===== -->
<section class="tab">
<h2>Tasdiqlash</h2>
<div class="card summary">
    <p><b>Mijoz:</b> {{ loan.client.full_name }}</p>
    <p><b>Mahsulot:</b> {{ loan.product.name }}</p>
    <p><b>Jami summa:</b> {{ loan.amount|intcomma }} soâ€˜m</p>
    <p><b>Oylik toâ€˜lov:</b> {{loan.payment|intcomma}} so'm</p>
    <p><b>Muddati:</b> {{ loan.term }} oy</p>
    <p><b>To'lov sanasi:</b> {{ loan.payday }}</p>
    
</div>
</section>

<!-- ===== TAB 5 ===== -->
<section class="tab">
<h2>Hujjatlar</h2>
<div class="card">
    <div class="doc">Ariza <a href="{% url 'document' loan.id 'request' %}" id="to_pdf" class="primary">CHIQARISH</a></div><hr>
    <div class="doc">Rozilik xati <a href="{% url 'document' loan.id 'agreement' %}" id="to_pdf" class="primary">CHIQARISH</a></div><hr>
    <div class="doc">Axborot varaqasi <a href="{% url 'document' loan.id 'information' %}" id="to_pdf" class="primary">CHIQARISH</a></div><hr>
    <div class="doc">Shartnoma <a href="{% url 'document' loan.id 'contract' %}" id="to_pdf" class="primary">CHIQARISH</a></div><hr>
    <div class="doc">To'lov grafigi <a href="{% url 'document' loan.id 'graphic' %}" id="to_pdf" class="primary">CHIQARISH</a></div><hr>
    <div class="doc">Farmoyish <a href="{% url 'document' loan.id 'order' %}" id="to_pdf" class="primary">CHIQARISH</a></div><hr>
    <div class="doc">Kuzatuv <a href="{% url 'document' loan.id 'kuzatuv' %}" id="to_pdf" class="primary">CHIQARISH</a></div><hr>
    <div class="doc">Betlik <a href="{% url 'document' loan.id 'betlik' %}" id="to_pdf" class="primary">CHIQARISH</a></div>
</div>
</section>

<!-- ===== TAB 6 ===== -->
<section class="tab">
<h2>Yakunlash</h2>
<div class="card end">
    <p>Davom etish uchun buxgalterigaga o'ting</p>
    <button class="primary large" onclick="approve()">
        Yakunlash
    </button>
</div>
</section>

</main>
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">
<!-- ================= FOOTER ================= -->
<footer class="footer-nav">
    <button class="ghost" onclick="prevTab()">Orqaga</button>
    <a href="{% url 'requests' %}" class="ghost" style="text-decoration: none;color:black;font-size: 13px;">Arizalar tarixi</a>
    <button class="danger" onclick="reject()">Bekor qilish</button>
    <button class="primary" onclick="nextTab()">Keyingi</button>
</footer>

<!-- ================= JS ================= -->
<script>
    
    if ("{{loan.status}}" === "rejected" || "{{loan.status}}" === "done" || "{{loan.status}}" === "approved" || "{{loan.status}}" === "paid"){
        document.querySelectorAll('.tab').forEach(f=>{
            f.querySelectorAll('input,select,button').forEach(i=>{
                if(
                    i.id !== "make_graphic" &&
                    i.id !== "to_pdf"
                )
            i.disabled = true;
            i.readOnly = true;
            })
        })
    }

function send_data(){
    let inputs = document.querySelectorAll("input, select")
    let data = {}
    inputs.forEach((i,index)=>{
        data[i.id] = i.value;
    })
    $.ajax({
        url: "{% url 'save_data' %}",
        method: "POST",
        headers: {
            "X-CSRFToken": document.getElementById("csrf_token").value
        },
        data: {
            data: JSON.stringify(data),
            id: "{{loan.id}}"
        },
        success: function( result ) {
            
        }
    });
    // console.log(data)
}

function save_product(){
    send_data();
    setTimeout(()=>{
        window.location.reload()
    },100)
}


function add_client(){
    let pinfl = document.getElementById("client_pinfl").value
    // console.log("searching for client")
    $.ajax({
        url: "{% url 'add_client' %}",
        method: "POST",
        headers: {
            "X-CSRFToken": document.getElementById("csrf_token").value
        },
        data: {
            pinfl: pinfl,
            id: "{{loan.id}}"
        },
        success: function( result ) {
            if (result.status === true){
                spawnAlert('Mijoz topildi','success')
                setTimeout(()=>{
                    window.location.reload()
                },1000)
            } else {
                spawnAlert('Mijoz topilmadi','error')
            }
        }
    });
}

function save_number(){
    let number = document.getElementById("new_number").value
    let desc = document.getElementById("new_number_comment").value
    if (number && desc)
    {
        $.ajax({
            url: "{% url 'save_number' %}",
            method: "POST",
            headers: {
                "X-CSRFToken": document.getElementById("csrf_token").value
            },
            data: {
                loan: "{{loan.id}}",
                number: number,
                desc: desc
            },
            success: function( result ) {
                if (result.status === true){
                    // console.log(result.number)
                    spawnAlert("Raqam saqlandi",'success')
                    numbers_list = document.querySelector(".number_list")
                    numbers_list.innerHTML = ''
                    Object.entries(result.numbers).forEach(([name,number])=>{
                        numbers_list.innerHTML += `
                        <div class="doc">
                            <span>${number}</span>
                            <span>${name}</span>
                            <button class="danger" onclick="deleteItem(this)">Oâ€˜chirish</button>
                        </div>
                        `
                    })
                    document.getElementById("new_number").value = "";
                    document.getElementById("new_number_comment").value = "";
                } else {
                    spawnAlert('Raqam saqlashda xatolik','error')
                }
            }
        });
    }
    
}

function delete_number(el){
    fetch(`/delete_number/${el.id}/`, { method: 'POST', 
        headers: {
            "X-CSRFToken": document.getElementById("csrf_token").value
        }
    })
    document.querySelector(`.number_${el.id}`).remove()
}

function reject(){
    $.ajax({
        url: "{% url 'reject' %}",
        method: "POST",
        headers: {
            "X-CSRFToken": document.getElementById("csrf_token").value
        },
        data: {
            id: "{{loan.id}}"
        },
        success: function( result ) {
            if (result.status === true){
                spawnAlert(result.msg,'success')
            } else {
                spawnAlert(result.msg,'error')
            }
        }
    });
}

function approve(){
        $.ajax({
            url: "{% url 'approve' %}",
            method: "POST",
            headers: {
                "X-CSRFToken": document.getElementById("csrf_token").value
            },
            data: {
                loan_id: "{{loan.id}}"
            },
            success: function( result ) {
                if (result.status === true){
                    spawnAlert(result.msg,'success')
                } else {
                    spawnAlert(result.msg,'error')
                }
            }
        });
    }



// ===== TAB LOGIC WITH URL & LOCALSTORAGE =====
let tabs = document.querySelectorAll(".tab");
let steps = document.querySelectorAll(".step");
let current = 0;

// Read ?tab= or localStorage
const url = new URL(window.location);
const page = url.searchParams.get("tab");
if(page && !isNaN(page) && page>=0 && page<tabs.length){
    current = Number(page);
}

function showTab(i){
    tabs.forEach(t=>t.classList.remove("active"));
    steps.forEach(s=>s.classList.remove("active"));
    tabs[i].classList.add("active");
    steps[i].classList.add("active");
    current = i;

    // Update URL and localStorage
    url.searchParams.set("tab",i);
    window.history.replaceState({}, "", url);
    send_data()
}
function nextTab(){ if(current < tabs.length-1) showTab(current+1); }
function prevTab(){ if(current > 0) showTab(current-1); }
steps.forEach((s,i)=>s.onclick=()=>showTab(i));

// Initialize
showTab(current);

// ===== ALERT SYSTEM =====
function spawnAlert(text,type='info'){
    const a=document.createElement("div");
    a.className="alert "+type;
    a.innerText=text;
    document.getElementById("alerts").appendChild(a);
    setTimeout(()=>a.classList.add("hide"),2500);
    setTimeout(()=>a.remove(),3000);
}

// ===== MONTHLY PAYMENT CALCULATION =====
function calculateMonthlyPayment(){
    const principal = parseFloat(document.getElementById("price").value);
    const rateYear  = parseFloat(document.getElementById("loan_rate").value);
    const startStr  = document.getElementById("loan_start_date").value;
    const endStr    = document.getElementById("loan_end_date").value;
    const payday    = parseInt(document.getElementById("payday").value);

    if(!principal || !rateYear || !startStr || !endStr || !payday) return;

    const start = new Date(startStr);
    const end   = new Date(endStr);

    if(end <= start) return;

    // ===== TOTAL WITH INTEREST (simple yearly) =====
    const total = principal + (principal * rateYear / 100);

    // ===== COUNT REAL PAYMENT DATES =====
    let count = 0;
    let cursor = new Date(start.getFullYear(), start.getMonth(), 1);

    while(cursor <= end){
        const year = cursor.getFullYear();
        const month = cursor.getMonth();

        // last day of month (Feb, 30/31 handled)
        const lastDay = new Date(year, month + 1, 0).getDate();
        const day = Math.min(payday, lastDay);

        const dueDate = new Date(year, month, day);

        if(dueDate >= start && dueDate <= end){
            count++;
        }

        cursor.setMonth(cursor.getMonth() + 1);
    }

    if(count === 0) return;

    const monthly = total / count;

    // ===== UI UPDATE =====
    document.getElementById("monthly_payment").value =
        Math.round(monthly).toLocaleString("ru-RU") + " so'm";

    document.getElementById("confirm_monthly").innerText =
        Math.round(monthly).toLocaleString("ru-RU") + " so'm";

    // (optional) save hidden values for backend
    window._lkrd_payment_count = count;
    window._lkrd_total_amount = Math.round(total);
}


document.getElementById("loan_end_date").addEventListener("change", calculateMonthlyPayment);
document.getElementById("loan_rate").addEventListener("input", calculateMonthlyPayment);
document.getElementById("payday").addEventListener("input", calculateMonthlyPayment);
window.onload = calculateMonthlyPayment;
</script>

</body>
</html>
