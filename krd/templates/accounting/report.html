{% load humanize %}
<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hisobotlar – FlowFin</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
    --primary:#0f6b3d;
    --bg:#f4f6f8;
    --border:#dcdfe4;
}
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg)}

.topbar{
    background:linear-gradient(135deg,var(--primary),#094a29);
    color:#fff;
    padding:16px 24px;
}

.container{
    max-width:1200px;
    margin:auto;
    padding:24px;
}

.card{
    background:#fff;
    border-radius:16px;
    border:1px solid var(--border);
    padding:20px;
    margin-bottom:20px;
}

.filters{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
    align-items:center;
}

.filters input[type="date"],
.filters input[type="text"]{
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--border);
}

.filters button{
    padding:10px 18px;
    border-radius:12px;
    border:none;
    background:var(--primary);
    color:#fff;
    font-weight:600;
    cursor:pointer;
}

/* Table */
table{
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
}

th,td{
    padding:12px 14px;
    text-align:left;
    border-bottom:1px solid var(--border);
}

th{
    background:#f9fafb;
    font-size:13px;
    text-transform:uppercase;
    color:#555;
}

.badge{
    padding:6px 10px;
    border-radius:20px;
    font-size:12px;
    font-weight:600;
    color:#fff;
}

.paid{background:#dcfce7;color:#166534;}
.unpaid{background:#fee2e2;color:#991b1b;}

@media print {
    body * {visibility:hidden;}
    #printable, #printable * {visibility:visible;}
    #printable {position:absolute;top:0;left:0;width:100%;}
}
</style>
</head>

<body>

<header class="topbar">
    <h1>Hisobotlar | Jami: {{payments.count}}</h1>
</header>

<main class="container">

<!-- Filters -->
<div class="card">
    <form class="filters" method="get">
        <label>
            Boshlanish sana:
            <input type="date" id="fromDate" name="start_date" value="{{start_date}}">
        </label>
        <label>
            Tugash sana:
            <input type="date" id="toDate" name="end_date" value="{{end_date}}">
        </label>
        <label>
            Qidirish:
            <input type="text" id="searchQuery" name="contract_id" value="{{contract_id}}" placeholder="Mijoz yoki kredit №">
        </label>
        <button type="submit">Ko‘rsatish</button>
        <button onclick="printReport()">Print</button>
    </form>
</div>

<!-- Report Table -->
<div class="card" id="printable">
    <table id="reportTable">
        <thead>
            <tr>
                <th>Sana</th>
                <th>Kredit №</th>
                <th>Mijoz</th>
                <th>Summa</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% if payments %}
                {% for i in payments %}
                    <tr>
                        <td>{{i.payment_date}}</td>
                        <td>{{i.loan.contract_id}}</td>
                        <td>{{i.loan.client.full_name}}</td>
                        <td>{{i.payment|intcomma}} so'm</td>
                        <td><span class="badge paid">To‘langan</span></td>
                    </tr>
                {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>

</main>

<script>
// Filter table by date and search
function filterTable() {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    const search = document.getElementById("searchQuery").value.toLowerCase();
    const table = document.getElementById("reportTable");
    const trs = table.tBodies[0].rows;

    for (let row of trs) {
        const date = row.cells[0].textContent;
        const contract = row.cells[1].textContent.toLowerCase();
        const client = row.cells[2].textContent.toLowerCase();
        let show = true;

        if (from && date < from) show = false;
        if (to && date > to) show = false;
        if (search && !(contract.includes(search) || client.includes(search))) show = false;

        row.style.display = show ? "" : "none";
    }
}

// Print button
function printReport() {
    window.print();
}
</script>

</body>
</html>
