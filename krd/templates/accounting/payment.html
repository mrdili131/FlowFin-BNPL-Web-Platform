{% load humanize %}
<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlowFin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{--p:#0f6b3d;--bd:#dcdfe4;--bg:#f4f6f8}
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg)}

header{
  background:linear-gradient(135deg,#0f6b3d,#094a29);
  color:#fff;padding:18px 24px
}

.container{max-width:1000px;margin:auto;padding:24px}

/* SEARCH UI ONLY */
.search{
  display:flex;gap:10px;margin-bottom:20px
}
.search input{
  flex:1;padding:12px;border-radius:12px;border:1px solid var(--bd)
}
.search button{
  padding:12px 16px;border-radius:12px;
  border:none;background:#0f6b3d;color:#fff
}

/* INFO */
.loan-info{
  background:#fff;border-radius:16px;
  padding:18px;border:1px solid var(--bd);
  margin-bottom:16px
}

/* PAYMENT BAR */
.controls{
  background:#fff;border-radius:16px;
  padding:16px;border:1px solid var(--bd);
  margin-bottom:16px;
  display:flex;gap:10px;flex-wrap:wrap
}
.controls input{
  flex:1;padding:12px;border-radius:12px;border:1px solid var(--bd)
}
.controls button{
  padding:12px 16px;border-radius:12px;
  border:none;
}
.primary{background:#0f6b3d;color:#fff}
.danger{background:#b91c1c;color:#fff}

/* MONTHS */
.months{
  background:#fff;border-radius:16px;
  border:1px solid var(--bd);overflow:hidden
}
.month{
  display:grid;
  grid-template-columns:80px 1fr 1fr 1fr;
  gap:10px;padding:14px 16px;
  border-bottom:1px solid var(--bd)
}
.month:last-child{border-bottom:none}

.badge{
  padding:6px 10px;border-radius:20px;
  font-size:12px;font-weight:700
}
.paid{background:#dcfce7;color:#166534}
.unpaid{background:#fef3c7;color:#92400e}
.overdue{background:#fee2e2;color:#991b1b}

.label{font-size:12px;color:#555}
.value{font-weight:700}
</style>
</head>
<body>

<header>
  <a href="{% url 'accounting:home' %}" style="text-decoration: none;color: white;"><h2>üìä Kredit To‚Äòlovlari (Ko‚Äòrish)</h2></a>
</header>

<div class="container">

<!-- SEARCH (UI ONLY) -->
<form class="search" method="get">
  <input placeholder="Kredit ‚Ññ ni kiriting" type="search" name="q" value="{{q}}">
  <button type="submit">üîç Qidirish</button>
</form>

{% if loan %}
<!-- LOAN INFO -->
<div class="loan-info">
  <div><b>Mijoz:</b> {{loan.client.full_name}}</div>
  <div><b>Kredit ‚Ññ:</b> {{loan.contract_id}}</div>
  <div><b>Oylik to‚Äòlov:</b> {{loan.payment|intcomma}} so‚Äòm</div>
  <div><b>Muddat:</b> {{loan.term}} oy</div>
  <div><b>Qolgan summa:</b> {{loan.total|intcomma}} so‚Äòm</div>
</div>

<!-- PAYMENT INPUT (READ ONLY) -->
<div class="controls">
  <input placeholder="To‚Äòlov summasi" type="number" id="amount">
  <button class="primary" onclick="pay({{loan.id}})">üí≥ To‚Äòlash</button>
  <button class="danger">üí∞ Kreditni yopish</button>
</div>

<!-- MONTHS TABLE -->
<div class="months">
{% for i in loan.payment_months.all %}
  <div class="month">
    <div><b>{{i.month}}-oy</b></div>
    <div><div class="label">To'lash kerak</div><div class="value">{{ i.left_amount|intcomma }} so'm</div></div>
    <div><div class="label">Jarima</div><div class="value">{{i.penalty|intcomma}} so'm</div></div>
    {% if i.is_paid %}
        <div><span class="badge paid">To‚Äòlangan</span></div>
    {% else %}
        <div><span class="badge unpaid">To‚Äòlanmagan</span></div>
    {% endif %}
  </div>
  {% endfor %}

</div>
{% endif %}

</div>

</body>
</html>

<script>
    function pay(id){
        let amount = document.getElementById("amount").value
        if (amount > 0){
            let url = `/accounting/pay/${id}/${amount}`
            fetch (url)
            setTimeout(()=>{
                window.location.reload()
            },500)
        }
    }
</script>
